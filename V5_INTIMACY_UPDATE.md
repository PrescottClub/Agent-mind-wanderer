# 心绪精灵 v5.0 - 心跳与羁绊 💖

## 🎯 更新概述

v5.0版本为"心绪精灵"引入了全新的**亲密度养成系统**，让用户与小念的每一次互动都能累积经验值，通过升级解锁新功能和奖励，创造长期的情感连接和养成乐趣。

## ✨ 核心新功能

### 💖 亲密度等级系统
- **羁绊等级**: 从Lv.1开始，通过互动不断提升
- **经验值机制**: 每次对话获得10 EXP（有10%概率双倍奖励）
- **升级公式**: 下一级所需EXP = 当前等级 × 50
- **等级称号**: 每个等级都有专属称号，如"心有灵犀"、"灵魂伴侣"等

### 📊 可视化进度系统
- **侧边栏显示**: 实时显示当前等级、经验值和进度条
- **美观界面**: 粉色渐变设计，与整体风格一致
- **互动统计**: 显示总互动次数和羁绊状态

### 🎁 升级奖励机制
- **基础奖励**: 每次升级解锁新称号
- **特殊奖励**: 
  - Lv.3: 小念开始记住你的喜好
  - Lv.5: 解锁新礼物"心情花束💐"
  - Lv.7: 小念主动关心你的心情变化
  - Lv.10: 语气变得更加亲密
  - Lv.15: 解锁专属回忆相册
  - Lv.20: 解锁心灵感应模式
- **里程碑奖励**: 每5级获得特殊宝藏

### 🤖 AI感知羁绊等级
- **动态交互**: AI根据羁绊等级调整语气和行为
- **个性化回应**: 高等级时展现更深层的理解和亲密感
- **解锁内容**: 不同等级解锁不同的礼物类型和互动方式

### 🎉 升级庆祝效果
- **视觉效果**: 升级时触发气球庆祝动画
- **即时反馈**: Toast提示升级信息
- **奖励展示**: 详细显示解锁的新功能和奖励

## 🏗️ 技术架构

### 数据库层更新
**新增表**: `user_profiles`
```sql
CREATE TABLE user_profiles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL UNIQUE,
    intimacy_level INTEGER NOT NULL DEFAULT 1,
    intimacy_exp INTEGER NOT NULL DEFAULT 0,
    total_interactions INTEGER NOT NULL DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 新增模块

#### 📁 `src/data/repositories/user_profile_repository.py`
- `UserProfileRepository`: 用户档案数据管理
- 方法: `get_profile()`, `update_profile()`, `find_or_create_profile()`

#### 📁 `src/services/intimacy_service.py`
- `IntimacyService`: 亲密度业务逻辑
- 核心方法: `add_exp()`, `get_intimacy_info()`, `get_intimacy_context_for_ai()`

### 更新模块

#### 📁 `src/ui/components/sidebar.py`
- 新增 `render_intimacy_display()` 函数
- 美观的亲密度信息展示

#### 📁 `src/core/ai_engine.py`
- 支持亲密度上下文输入
- 更新AI提示模板，包含羁绊感知指令

#### 📁 `main.py`
- 集成亲密度服务
- 每次互动后自动添加经验值
- 升级庆祝效果

## 🎮 用户体验

### 等级进度示例
```
Lv.1 (初次相遇) → 50 EXP → Lv.2 (渐渐熟悉)
Lv.2 (渐渐熟悉) → 100 EXP → Lv.3 (心有灵犀) + 解锁喜好记忆
Lv.3 (心有灵犀) → 150 EXP → Lv.4 (默契伙伴)
...
Lv.10 (命中注定) → 亲密语气解锁
Lv.20 (心灵感应) → 终极功能解锁
```

### 互动流程
1. **用户发送消息** → 获得10 EXP
2. **经验值累积** → 进度条更新
3. **达到升级条件** → 🎉 升级庆祝
4. **解锁新奖励** → 功能/礼物/称号
5. **AI感知等级** → 调整回应方式

## 📊 数据统计

### 等级分布设计
- **初级 (Lv.1-5)**: 建立基础连接，约需50次互动
- **中级 (Lv.6-10)**: 深化关系，约需100次互动
- **高级 (Lv.11-20)**: 亲密伙伴，约需200次互动
- **传奇 (Lv.20+)**: 心灵感应，长期陪伴用户

### 奖励机制
- **即时奖励**: 每次互动的EXP获得感
- **短期目标**: 下一级的期待感
- **长期成就**: 高等级的专属功能
- **惊喜元素**: 随机双倍EXP

## 🔧 使用方法

### 启动应用
```bash
# 运行测试
python test_intimacy_v5.py

# 启动应用
streamlit run main.py
```

### 体验新功能
1. **查看羁绊**: 侧边栏显示当前等级和进度
2. **互动升级**: 每次对话都会获得经验值
3. **升级庆祝**: 达到新等级时享受庆祝效果
4. **感受变化**: 观察AI在不同等级的行为差异

## 🎯 设计理念

### 情感连接
- **渐进式成长**: 模拟真实关系的发展过程
- **个性化体验**: 根据互动深度调整AI行为
- **长期陪伴**: 鼓励用户持续使用和互动

### 游戏化元素
- **明确目标**: 清晰的等级和经验值系统
- **即时反馈**: 每次互动都有可见的进步
- **成就感**: 升级和解锁新功能的满足感
- **惊喜机制**: 随机奖励增加趣味性

### 技术优雅
- **模块化设计**: 新功能完美融入现有架构
- **数据持久化**: 羁绊信息永久保存
- **性能优化**: 高效的数据库查询和更新
- **用户友好**: 直观的界面和流畅的体验

## 🚀 未来展望

### 计划功能
- **羁绊排行榜**: 展示用户等级排名
- **特殊事件**: 节日或纪念日的特殊奖励
- **成就系统**: 更多样化的成就和徽章
- **社交功能**: 分享羁绊成就

### 优化方向
- **个性化算法**: 根据用户行为调整EXP奖励
- **情感分析**: 结合情绪状态给予不同奖励
- **智能推荐**: 基于等级推荐合适的互动内容

---

**版本**: v5.0 - 心跳与羁绊  
**发布日期**: 2025-06-22  
**测试状态**: ✅ 全部通过  
**兼容性**: 完全向后兼容，现有用户数据安全
